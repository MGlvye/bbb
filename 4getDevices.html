<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>华为云 IoTDA 一键调用工具</title>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
            background: #f4f4f4;
        }

        button {
            padding: 12px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        #log {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border: 1px solid #ddd;
            min-height: 200px;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <h1>华为云 IoTDA 本地控制台</h1>
    <button onclick="step1_getToken()">1. 获取 Token</button>
    <button onclick="step2_getProject()">2. 获取 Project ID</button>
    <button onclick="step3_getDevices()">3. 获取设备列表</button>
    <button onclick="step4_getDeviceShadow()">4. 获取设备状态</button>
    <button onclick="runall()">一键获取全部</button>
    <button onclick="clearLog()">清空日志</button>
    <div id="log">日志输出区：</div>

    <script>
        let token = '';
        let projectID = '';
        const endpoint = '132ba64707.st1.iotda-app.cn-south-1.myhuaweicloud.com';
        const LOG_KEY = 'iotda-local-log';
        function log(msg) {
            const div = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const line = `${timestamp} → ${msg}`;
            // 追加到页面
            div.innerHTML += '<br>' + line;
            div.scrollTop = div.scrollHeight;
            // 同时保存到本地（永不丢失）
            let history = JSON.parse(localStorage.getItem(LOG_KEY) || '[]');
            history.push(line);
            localStorage.setItem(LOG_KEY, JSON.stringify(history));
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '日志输出区：';
            localStorage.removeItem(LOG_KEY);
        }

        // 页面加载时自动恢复历史日志
        window.addEventListener('load', () => {
            const history = JSON.parse(localStorage.getItem(LOG_KEY) || '[]');
            const div = document.getElementById('log');
            div.innerHTML = '日志输出区：';
            history.forEach(line => div.innerHTML += '<br>' + line);
            div.scrollTop = div.scrollHeight;
        });

        //获取 Token
        async function step1_getToken() {
            try {
                const resp = await chrome.runtime.sendMessage({
                    type: 'proxy',
                    url: 'https://iam.myhuaweicloud.com/v3/auth/tokens',
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        auth: {
                            identity: {
                                methods: ["password"],
                                password: {
                                    user: {
                                        domain: { name: "hid_p6tqkqd64uyggab" },
                                        name: "hahaha",
                                        password: "a1801752475"
                                    }
                                }
                            },
                            scope: { project: { name: "cn-north-1" } }
                        }
                    })
                });

                token = resp.headers.get('X-Subject-Token');
                log('Token 获取成功！长度：' + token.length);
                alert('第1步完成！Token 已获取');
            } catch (e) {
                log('获取 Token 失败：' + e.message);
                alert('获取 Token 失败：' + e.message);
            }
        }

        //获取 Project ID
        async function step2_getProject() {
            if (!token) return alert('请先执行第1步获取 Token！');

            try {
                const resp = await fetch('http://localhost:8000/v3/auth/projects', {
                    method: 'GET',
                    headers: { 'X-Auth-Token': token }
                });

                const data = await resp.json();
                if (!data.projects || data.projects.length === 0) throw new Error('未找到项目');

                projectID = data.projects[0].id;
                log('Project ID 获取成功：' + projectID);
                alert('第2步完成！Project ID = ' + projectID);
            } catch (e) {
                log('获取 Project 失败：' + e.message);
                alert('获取 Project 失败：' + e.message);
            }
        }

        //获取设备列表
        async function step3_getDevices() {
            if (!token) return alert('请先获取 Token！');
            if (!projectID) return alert('请先获取 Project ID！');

            try {
                const url = `https://${endpoint}/v5/iot/${projectID}/devices`;
                const resp = await fetch('http://localhost:8000/proxy-iotda', {
                    method: 'GET',
                    headers: {
                        'X-Auth-Token': token,
                        'Target-Url': url
                    }
                });

                const data = await resp.json();
                const count = data.devices ? data.devices.length : 0;
                log(`设备获取成功！共 ${count} 台设备`);
                log('完整返回：\n' + JSON.stringify(data, null, 2));
                alert(`第3步完成！共找到 ${count} 台设备\n`);
            } catch (e) {
                log('获取设备失败：' + e.message);
                alert('获取设备失败：' + e.message);
            }
        }

        //获取单个设备的影子状态（Shadow）
        async function step4_getDeviceShadow() {
            if (!token) return alert('请先获取 Token！');
            const deviceId = prompt('请输入要查询的设备ID', 'IoTDev01')?.trim();
            if (!deviceId) return;
            const shadowEndpoint = 'd25a4c4c51.st1.iotda-app.cn-south-1.myhuaweicloud.com';
            try {
                const projResp = await fetch('http://localhost:8000/v3/auth/projects', {
                    headers: { 'X-Auth-Token': token }
                });
                const projData = await projResp.json();
                const correctProject = projData.projects.find(p => p.name === 'cn-south-1');
                if (!correctProject) throw new Error('未找到 cn-south-1 的项目');
                const realProjectID = correctProject.id;
                log(`使用 cn-south-1 项目ID：${realProjectID}`);
                const realUrl = `https://${shadowEndpoint}/v5/iot/${realProjectID}/devices/${deviceId}/shadow`;
                log(`正在请求设备影：${realUrl}`);
                const resp = await fetch('http://localhost:8000/proxy-iotda', {
                    method: 'GET',
                    headers: {
                        'X-Auth-Token': token,
                        'Target-Url': realUrl
                    }
                });

                if (!resp.ok) {
                    const err = await resp.text();
                    throw new Error(`HTTP ${resp.status}: ${err}`);
                }
                const data = await resp.json();
                log('设备影子获取成功！');
                log(JSON.stringify(data, null, 2));
                const shadow = data.shadow?.[0];
                if (!shadow) {
                    alert('获取到影子但为空');
                    return;
                }
                const reported = shadow.reported?.properties || {};
                const temp = reported.temperature ?? '未上报';
                const hum = reported.humidity ?? '未上报';
                let timeStr = '未知时间';
                if (shadow.reported?.event_time) {
                    const utcTime = shadow.reported.event_time.replace(
                        /(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})Z/,
                        '$1-$2-$3T$4:$5:$6Z'
                    );
                    timeStr = new Date(utcTime).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
                }
                const version = shadow.version || '未知';
                alert(`设备影子状态获取成功！
            设备 ID：${deviceId}
            版本号：${version}
            数据上报时间：${timeStr}
            当前温度：${temp} ℃
            当前湿度 ：${hum} %`
                );
            } catch (e) {
                log('获取设备影失败：' + e.message);
                alert('获取失败：' + e.message);
            }
        }
        async function runall() {
            const originalAlert = window.alert;
            window.alert = function (msg) {
                //log('弹窗内容：' + msg);
            };
            try {
                log('开始一键执行....');
                await step1_getToken();
                await step2_getProject();
                await step3_getDevices();
                window.alert = function (msg) {
                    log('弹窗内容：' + msg);
                };
                await step4_getDeviceShadow();
                log('全部执行完毕!');
            } catch (e) {
                alert('出错了：' + e.message);
            } finally {
                window.alert = originalAlert;
            }
        }
    </script>
</body>

</html>